pipeline {
    agent any

    environment {
        LOCAL_TOMCAT_DIR = 'C:\\Users\\nveerla\\Desktop\\apache-tomcat-10.1.20\\webapps' // Adjust the Tomcat webapps directory path
        APP_URL = 'http://localhost:8080/democicd' // Adjust the application's context path
        TOMCAT_BIN_DIR = 'C:\\Users\\nveerla\\Desktop\\apache-tomcat-10.1.20\\bin' // Tomcat bin directory for restarting
    }

    stages {

        stage('Checkout Code') {
            steps {
                echo 'Cloning Git repository...'
                git branch: 'main', credentialsId: 'git-credentials', url: 'https://github.com/your-org/your-repo.git'
            }
        }

        stage('Build Application') {
            steps {
                echo 'Building application using Maven...'
                bat 'mvn clean package -DskipTests'
            }
        }

        stage('Package Artifact') {
            steps {
                echo 'Packaging application for deployment...'
                archiveArtifacts artifacts: 'target/*.war', fingerprint: true
            }
        }

        stage('Deploy to Local Machine') {
            steps {
                echo 'Deploying WAR file to local Tomcat...'
                bat """
                copy target\\*.war ${LOCAL_TOMCAT_DIR}
                """
            }
        }

        stage('Restart Local Tomcat') {
            steps {
                echo 'Restarting local Tomcat server...'
                bat """
                cd ${TOMCAT_BIN_DIR}
                call shutdown.bat
                call startup.bat
                """
            }
        }

        stage('Post Deployment Check') {
            steps {
                echo 'Verifying deployment...'
                script {
                    def response = bat(script: "curl -I ${APP_URL}", returnStdout: true).trim()
                    echo "Response: ${response}"
                }
            }
        }
    }

    post {
        success {
            echo 'Deployment successful!'
            mail to: 'nageswararao.veerla@concentrix.com',
                 subject: 'Deployment Successful',
                 body: 'The latest build has been deployed successfully to the local Tomcat server.'
        }
        failure {
            echo 'Deployment failed! Notifying team...'
            mail to: 'nageswararao.veerla@concentrix.com',
                 subject: 'Deployment Failed',
                 body: 'The deployment to the local machine failed. Please check Jenkins logs for details.'
        }
    }
}
